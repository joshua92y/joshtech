# ğŸ”§ ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Build & Deploy FastAPI to GHCR and OCI

on:
  # ğŸŸ¡ ë³€ê²½ ê°ì§€ ê²½ë¡œ ì„¤ì •
  push:
    paths:
      - 'apps/backend_api/**' # FastAPI ë°±ì—”ë“œ ì½”ë“œ
      - 'packages/shared_schemas/**' # ê³µí†µ Pydantic ìŠ¤í‚¤ë§ˆ
      - '.github/workflows/deploy-fastapi-ghcr.yml' # ì´ ì›Œí¬í”Œë¡œìš° ìì²´
      - 'infra/oci/**' # ë°°í¬ ê´€ë ¨ ì¸í”„ë¼ ì„¤ì •
  workflow_dispatch: # âœ… ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ ì§€ì›

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # GitHub Actions ëŸ°íƒ€ì„ í™˜ê²½

    steps:
      # âœ… 1. í˜„ì¬ GitHub ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      # âœ… 2. GitHub Container Registry(GHCR)ì— ë¡œê·¸ì¸
      - name: ğŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # âœ… 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° GHCRë¡œ í‘¸ì‹œ
      - name: ğŸ³ Build and Push Docker image to GHCR
        run: |
          docker build \
            -t ghcr.io/${{ github.repository_owner }}/joshtech-fastapi:latest \
            -f apps/backend_api/Dockerfile .
          docker push ghcr.io/${{ github.repository_owner }}/joshtech-fastapi:latest

      # âœ… 4. ë°°í¬ìš© êµ¬ì„± íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ ë””ë²„ê¹…
      - name: ğŸ” Debug file structure before SCP
        run: |
          echo "ğŸ“ Current directory: $PWD"
          echo "--- Showing files under ./infra/oci ---"
          find infra/oci
          echo "--- Checking required files ---"
          test -f infra/oci/docker-compose.yml && echo "âœ… Found docker-compose.yml" || echo "âŒ Missing docker-compose.yml"
          test -f infra/oci/traefik/traefik.yml && echo "âœ… Found traefik.yml" || echo "âŒ Missing traefik.yml"

      # âœ… 5. ì„œë²„ë¡œ docker-compose.yml, traefik.yml ë³µì‚¬ (strip_componentsë¡œ ê²½ë¡œ ì •ë¦¬)
      # âœ… docker-compose.yml ì „ì†¡
      - name: ğŸ“¤ Upload docker-compose.yml to OCI server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.OCI_HOST_FASTAPI_VM }}
          username: ubuntu
          key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}
          port: 22
          source: infra/oci/docker-compose.yml
          target: ~/deploy/joshtech/
          strip_components: 2
          overwrite: true
          debug: true

      # âœ… traefik.yml ì „ì†¡
      - name: ğŸ“¤ Upload traefik.yml to OCI server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.OCI_HOST_FASTAPI_VM }}
          username: ubuntu
          key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}
          port: 22
          source: infra/oci/traefik/traefik.yml
          target: ~/deploy/joshtech/
          strip_components: 2
          overwrite: true
          debug: true

      # âœ… 6. ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ docker composeë¡œ ë°°í¬ ì‹¤í–‰
      - name: ğŸš€ SSH into OCI and deploy using Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.OCI_HOST_FASTAPI_VM }}
          username: ubuntu
          key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd ~/deploy/joshtech
            echo "${{ secrets.GHCR_TOKEN }}" | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # âœ… traefik ë””ë ‰í† ë¦¬ì™€ ì¸ì¦ íŒŒì¼ ê¶Œí•œ ì„¤ì •
            sudo mkdir -p traefik
            [ -f traefik/acme.json ] || sudo touch traefik/acme.json
            sudo chmod 600 traefik/acme.json

            # âœ… ìµœì‹  ì´ë¯¸ì§€ Pull ë° ë°°í¬ ì‹¤í–‰ (Compose v2 ëª…ë ¹ì–´)
            sudo docker compose pull
            sudo docker compose up -d --remove-orphans
