# .github/workflows/deploy-fastapi-ghcr.yml
# âœ… ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Build & Deploy FastAPI to GHCR and Fly.io

# âœ… ì‹¤í–‰ ì¡°ê±´: ë‹¤ìŒ ë””ë ‰í† ë¦¬ì— ë³€ê²½ì´ ìƒê¸°ë©´ ì‹¤í–‰
on:
  push:
    paths:
      - 'apps/backend_api/**'
      - 'packages/shared_schemas/**'
      - '.github/workflows/deploy-fastapi-ghcr.yml'
      - 'infra/oci/**'
  workflow_dispatch: # âœ… ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ ì¶”ê°€

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # âœ… GitHub Actions ì‹¤í–‰ í™˜ê²½

    steps:
      # âœ… 1. í˜„ì¬ GitHub ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3

      # âœ… 2. GitHub Container Registry (GHCR)ì— ë¡œê·¸ì¸
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # âœ… 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ (FastAPI + shared_schemas í¬í•¨) ë° GHCRì— í‘¸ì‹œ
      - name: Build and push to GHCR
        run: |
          docker build \
            -t ghcr.io/${{ github.repository_owner }}/joshtech-fastapi:latest \
            -f apps/backend_api/Dockerfile .
                docker push ghcr.io/${{ github.repository_owner }}/joshtech-fastapi:latest
      # âœ… ğŸ” ë””ë²„ê¹…: ì‹¤ì œë¡œ íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
      - name: Debug file structure before SCP
        run: |
          echo "Current directory: $PWD"
          echo "--- Showing all files under ./infra/oci ---"
          find infra/oci
          echo "--- Showing docker-compose.yml exists? ---"
          test -f infra/oci/docker-compose.yml && echo "âœ… Found docker-compose.yml" || echo "âŒ Missing docker-compose.yml"
          test -f infra/oci/traefik/traefik.yml && echo "âœ… Found traefik.yml" || echo "âŒ Missing traefik.yml"

      # âœ… 4. docker-compose.yml + traefik ì„¤ì • íŒŒì¼ë“¤ì„ ì„œë²„ë¡œ ë³µì‚¬
      - name: Upload compose files to OCI
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.OCI_HOST_FASTAPI_VM }}
          username: ubuntu
          key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}
          source: |
            ./infra/oci/docker-compose.yml
            ./infra/oci/traefik/traefik.yml
          target: ~/deploy/joshtech/
          debug: true

      # âœ… 5. OCI ì„œë²„ì— SSH ì ‘ì† í›„ docker compose ì‹¤í–‰
      - name: Deploy to OCI via SSH (Compose v2)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.OCI_HOST_FASTAPI_VM }}
          username: ubuntu
          key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd ~/deploy/joshtech
            mv infra/oci/docker-compose.yml . || true  # ì´ë¯¸ ìˆìœ¼ë©´ ë¬´ì‹œ
            echo "${{ secrets.GHCR_TOKEN }}" | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin
            [ -f traefik/acme.json ] && sudo chmod 600 traefik/acme.json
            sudo docker compose pull
            sudo docker compose up -d --remove-orphans
